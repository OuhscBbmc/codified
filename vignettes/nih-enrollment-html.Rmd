---
title: "NIH Enrollment Tables in HTML"
author: "Will Beasley and Peter Higgins"
date: '`r Sys.Date()`'
output:
  html_document:
    theme: simplex
    toc: true
    toc_depth: 2
    toc_float: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{NIH Enrollment Tables in HTML}
  %\VignetteEncoding{UTF-8}

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r declare, echo=F}
```

### Example with fake clinical trial data

You can use a hosted fake clinical trial dataset to demonstrate how to extract demographic data from REDCap.

First, install the `REDCap` and `codified` packages if necessary, and then [load them into memory](http://r-pkgs.had.co.nz/package.html#package).  


```{r install}
if( !requireNamespace("REDCapR", quietly=T) )
  install.packages("REDCapR")

if( !requireNamespace("codified", quietly=T) )
  devtools::install_github(repo= "OuhscBbmc/codified")

library(REDCapR)
library(codified)
```

Next, download the data from the REDCap database into the dataframe object fake_redcap_demodata

```{r download}
fake_redcap_demodata <- REDCapR::redcap_read_oneshot(
  redcap_uri = "https://bbmc.ouhsc.edu/redcap/api/",  
  token      = "F304DEC3793FECC3B6DEEFF66302CAD3",
  guess_type = FALSE
)$data


```

Now, convert these demographic data into a properly formatted NIH enrollment table

```{r convert}
table_nih_enrollment(fake_redcap_demodata)
```


## Establish Datasets


```{r establish}
library(magrittr)

path <- system.file("misc/example-data-1.csv", package="codified")
col_types <- readr::cols_only(
  record_id = readr::col_integer(),
  name_last = readr::col_character(),
  dob       = readr::col_date(format = ""),
  gender    = readr::col_integer(),
  race      = readr::col_integer(),
  ethnicity = readr::col_integer()
)
ds <- readr::read_csv(path, col_types=col_types) %>%
  dplyr::mutate(
    gender     = as.character(gender),
    race       = as.character(race),
    ethnicity  = as.character(ethnicity)
  )
ds %>% 
  head(10) %>% 
  knitr::kable(caption = "Observed Dataset (first ten rows)")

ds_lu_gender <- tibble::tribble(
  ~input,   ~displayed                      ,
  "0"   ,  "Female",
  "1"   ,  "Male",
  "U"   ,  "Unknown/Not Reported"
)
knitr::kable(ds_lu_gender, caption = "Gender Mapping")

ds_lu_race <- tibble::tribble(
  ~input ,   ~displayed                      ,
  "1"    , "American Indian/Alaska Native",
  "2"    , "Asian",
  "3"    , "Native Hawaiian or Other Pacific Islander",
  "4"    , "Black or African American",
  "5"    , "White",
  "M"    , "More than One Race",
  "6"    , "Unknown or Not Reported"
)
knitr::kable(ds_lu_race, caption = "Race Mapping")

ds_lu_ethnicity <- tibble::tribble(
  ~input,   ~displayed                      ,
  "2"   ,  "Not Hispanic or Latino"         ,
  "1"   ,  "Hispanic or Latino"             ,
  "0"   ,  "Unknown/Not Reported Ethnicity"
)
knitr::kable(ds_lu_ethnicity, caption = "Ethnicity Mapping")
```


##  Apply Map to Observed Dataset

```{r apply-map}
ds_summary_long <- codified::table_nih_enrollment(
  d              = ds,
  d_lu_gender    = ds_lu_gender,
  d_lu_race      = ds_lu_race,
  d_lu_ethnicity = ds_lu_ethnicity
)

knitr::kable(ds_summary_long, caption = "Counts of Each Subgroup")
```


##  Conform to NIH Cosmetics 

```{r cosmetically-format}
codified::table_nih_enrollment_pretty(
  d              = ds,
  d_lu_gender    = ds_lu_gender,
  d_lu_race      = ds_lu_race,
  d_lu_ethnicity = ds_lu_ethnicity
)
```
